<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/strategies/topOfOrderBook.ts | socktrader</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Websocket based trading bot for cryptocurrencies"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="socktrader"><meta property="twitter:description" content="Websocket based trading bot for cryptocurrencies"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/cwouter/SockTrader"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core">core</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/backTester.ts~BackTester.html">BackTester</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/candleCollection.ts~CandleCollection.html">CandleCollection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/candleLoader.ts~CandleLoader.html">CandleLoader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/liveTrader.ts~LiveTrader.html">LiveTrader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/orderbook.ts~Orderbook.html">Orderbook</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/sockTrader.ts~SockTrader.html">SockTrader</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core-analyzers">core/analyzers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/analyzers/capitalAnalyzer.ts~CapitalAnalyzer.html">CapitalAnalyzer</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core-exchanges">core/exchanges</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/exchanges/baseExchange.ts~BaseExchange.html">BaseExchange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/exchanges/hitBTC.ts~HitBTC.html">HitBTC</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/exchanges/hitBTCMapper.ts~HitBTCMapper.html">HitBTCMapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/exchanges/localExchange.ts~LocalExchange.html">LocalExchange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CandleInterval">CandleInterval</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core-strategy">core/strategy</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/strategy/baseStrategy.ts~BaseStrategy.html">BaseStrategy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-crossDown">crossDown</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-crossUp">crossUp</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core-web">core/web</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-spawnServer">spawnServer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-actions">actions</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#strategies">strategies</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/strategies/myStrategy.ts~MyStrategy.html">MyStrategy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/strategies/simpleMovingAverage.ts~SimpleMovingAverage.html">SimpleMovingAverage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/strategies/topOfOrderBook.ts~TopOfOrderbook.html">TopOfOrderbook</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/strategies/topOfOrderBook.ts</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import numeral from &quot;numeral&quot;;
import {ICandle} from &quot;../core/candleCollection&quot;;
import {IExchange} from &quot;../core/exchanges/exchangeInterface&quot;;
import logger from &quot;../core/logger&quot;;
import Orderbook, {IOrderbookEntry, Operator, OrderbookSide} from &quot;../core/orderbook&quot;;
import {IOrder, OrderSide, OrderStatus, ReportType} from &quot;../core/orderInterface&quot;;
import BaseStrategy from &quot;../core/strategy/baseStrategy&quot;;
import {Pair} from &quot;../types/pair&quot;;

export default class TopOfOrderbook extends BaseStrategy {
    adjPosition: { price: number; size: number } = {price: 0, size: 0};
    allow: { buy: boolean; sell: boolean } = {buy: true, sell: false};
    boughtPrice = 0;
    lastSpread = 0;

    // @TODO verify quantity with quantityIncrement from exchange config cache
    qty = 10;

    constructor(public pair: Pair, public exchange: IExchange) {
        super(pair, exchange);
    }

    /**
     * Convert buy/sell to an orderbook side. Can be used to operate on an orderbook.
     */
    static getObSide(side: OrderSide): OrderbookSide {
        return (side === OrderSide.BUY) ? OrderbookSide.BID : OrderbookSide.ASK;
    }

    /**
     * Convert buy/sell to a math operator. Can be used to adjust prices to a side.
     */
    static getOperator(side: OrderSide): Operator {
        return (side === OrderSide.BUY) ? Operator.PLUS : Operator.MINUS;
    }

    /**
     * Validates if position is on top of the order book
     */
    static orderIsFirst(position: IOrderbookEntry, obEntry: IOrderbookEntry): boolean {
        return position.price === obEntry.price &amp;&amp; position.size === obEntry.size;
    }

    adjust(order: IOrder, price: number, qty: number): void {
        this.adjPosition = {price, size: qty};
        super.adjust(order, this.adjPosition.price, this.adjPosition.size);
    }

    /**
     * Adjust order to be right above or below highest/lowest bid/ask
     */
    adjustOrder(order: IOrder, orderbook: Orderbook, side: OrderSide): void {
        const [entry1] = orderbook.getEntries(TopOfOrderbook.getObSide(side), 1);
        let price = orderbook.getAdjustedPrice(entry1.price, TopOfOrderbook.getOperator(side));
        price = this.limitPriceAdjustment(price, orderbook, side);

        this.adjust(order, price, order.quantity);
        // logger.info(`Trying to beat ===&gt; PRICE: ${entry1.price} WITH: ${price}`);
    }

    limitPriceAdjustment(price: number, orderbook: Orderbook, side: OrderSide): number {
        let newPrice = price;

        if (side === OrderSide.SELL) {
            const limitPrice = orderbook.getAdjustedPrice(this.boughtPrice, Operator.PLUS, 5);
            newPrice = (price &lt; limitPrice) ? limitPrice : price;
        }

        return newPrice;
    }

    logSpread(): void {
        const orderbook: Orderbook = this.exchange.getOrderbook(this.pair);
        const bidEntry: IOrderbookEntry = orderbook.getEntries(OrderbookSide.BID, 1)[0];
        const askEntry: IOrderbookEntry = orderbook.getEntries(OrderbookSide.ASK, 1)[0];
        const incrPerc: number = Orderbook.getBidAskSpreadPerc(bidEntry.price, askEntry.price);

        if (incrPerc !== this.lastSpread) {
            logger.info(`${this.pair} ${numeral(incrPerc).format(&quot;0.0000%&quot;)} BID: ${bidEntry.price} ASK: ${askEntry.price}`);
        }

        this.lastSpread = incrPerc;
    }

    notifyOrder(order: IOrder): void {
        if (order.reportType === ReportType.TRADE &amp;&amp; order.status === OrderStatus.FILLED) {
            logger.input(`Order filled: ${JSON.stringify(order)}`);

            if (order.side === OrderSide.SELL) {
                this.allow = {buy: true, sell: false};

                const profit = order.price - this.boughtPrice;
                logger.info(`BUY PRICE: ${this.boughtPrice} SELL PRICE: ${order.price} PROFIT: ${profit}`);
            } else if (order.side === OrderSide.BUY) {
                this.allow = {buy: false, sell: true};
                this.boughtPrice = order.price;
            }
            this.adjPosition = {price: 0, size: 0};

        } else if (order.reportType === ReportType.REPLACED) {
            this.adjPosition = {price: order.price, size: order.quantity};
        }
    }

    /**
     * Optimize order and remove possible gaps with 2nd orderbook entry
     */
    optimizeOrder(order: IOrder, orderbook: Orderbook, side: OrderSide): void {
        const [entry1, entry2] = orderbook.getEntries(TopOfOrderbook.getObSide(side), 2);
        const diff = orderbook.getSatDiff(entry2.price, entry1.price);

        if (diff &gt; 1) {
            let optimizedPrice = orderbook.getAdjustedPrice(entry2.price, TopOfOrderbook.getOperator(side));
            optimizedPrice = this.limitPriceAdjustment(optimizedPrice, orderbook, side);

            this.adjust(order, optimizedPrice, order.quantity);
            // logger.info(`Move up to ===&gt; REAL PRICE: ${entry2.price} OPT.PRICE: ${optimizedPrice} DIFF: ${diff}`);
        }
    }

    placeOrder(side: OrderSide, orderbook: Orderbook): void {
        const obEntry: IOrderbookEntry = orderbook.getEntries(TopOfOrderbook.getObSide(side), 1)[0];
        const order: IOrder[] = this.exchange.getOpenOrders();

        if (order.length === 0 &amp;&amp; this.allow[side]) {
            this[side](this.pair, orderbook.getAdjustedPrice(obEntry.price, TopOfOrderbook.getOperator(side)), this.qty);
            this.allow[side] = false;
        } else if (order.length === 1 &amp;&amp; order[0].side === side) {
            if (TopOfOrderbook.orderIsFirst(this.adjPosition, obEntry)) {
                this.optimizeOrder(order[0], orderbook, order[0].side);
            } else {
                this.adjustOrder(order[0], orderbook, order[0].side);
            }
        }
    }

    updateCandles(candleCollection: ICandle[]): void {
        console.log(candleCollection[0]);
        console.log(candleCollection[candleCollection.length - 1]);
    }

    updateOrderbook(orderbook: Orderbook) {
        // this.logSpread();

        // this.placeOrder(OrderSide.BUY, orderbook);
        // this.placeOrder(OrderSide.SELL, orderbook);
    }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
